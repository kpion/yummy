"use strict";const Utils={expandString(e){if(!e.includes("{"))return[e];let t=e.match(/\{(.*?)\}/)[0],i=t.match(/(\d+)\s*-\s*(\d+)/).slice(1,3),s=[];for(let n=parseInt(i[0]);n<=parseInt(i[1]);n++){let i=e.replace(t,n);s.push(i)}return s},random:(e,t)=>Math.floor(Math.random()*(t-e+1)+e),randomInsideCircle(e,t=!0,i=!0){let s=e/2,n=Math.random(),r=Math.random();if(i&&r<n){let e=r;r=n,n=e}let l={x:r*s*Math.cos(2*Math.PI*n/r),y:r*s*Math.sin(2*Math.PI*n/r)};return l.x+=s,l.y+=s,t&&(l.x=parseInt(l.x),l.y=parseInt(l.y)),l}};class LightScene{}LightScene.Point=class{constructor(e=0,t=null){this.set(e,t)}set(e=null,t=null){if("number"==typeof e||"string"==typeof e)this.x=parseFloat(e),this.y=null!==t?parseFloat(t):e;else if(Array.isArray(e)){let t=e;this.x=parseFloat(t[0]),this.y=parseFloat(t[1])}else if("object"==typeof e){let t=e;this.x=t.x,this.y=t.y}else this.x=this.y=0;return this}add(e,t){let i=new this.constructor(e,t);return this.x+=i.x,this.y+=i.y,this}substract(e,t){let i=new this.constructor(e,t);return this.x-=i.x,this.y-=i.y,this}multiply(e,t){let i=new this.constructor(e,t);return this.x*=i.x,this.y*=i.y,this}scale(e,t){return this.multiply(e,t)}divide(e,t){let i=new this.constructor(e,t);return this.x/=i.x,this.y/=i.y,this}equals(e,t){let i=new this.constructor(e,t);return this.x===i.x&&this.y===i.y}clone(){return new this.constructor(this)}toString(){return JSON.stringify(this)}},LightScene.Rect=class{constructor(e){void 0!==e.x1?(this.x1=e.x1,this.y1=e.y1,this.x2=e.x2,this.y2=e.y2):void 0!==e.x&&void 0!==e.width?(this.x1=e.x,this.y1=e.y,this.x2=e.x+e.width,this.y2=e.y+e.height):this.x1=this.y1=this.x2=this.y2=null}width(){return this.x2-this.x1}height(){return this.y2-this.y1}center(){return new LightScene.Point(this.x1+this.width()/2,this.y1+this.height()/2)}};class Composer{}Composer.currentScript=document.currentScript,Composer.Ingredient=class{constructor(e,t){this.app=e,Object.assign(this,JSON.parse(JSON.stringify(t)))}hasMode(e){return!(!this.mode||!this.mode.toLowerCase().includes(e))}getType(){return void 0!==this.type?this.type:"particles"}getAppUrl(){return this.app.url}getImageUrls(){let e=null;e=this.img?this.img:`${this.name}/1.png`;let t=Utils.expandString(e);return t.forEach(((e,i)=>{t[i]=this.getAppUrl()+"/ingredients/"+e})),t}getThumbUrl(){return this.getImageUrls()[0]}getParticlesPositions(e="default"){let t=null;return void 0!==this.positions&&void 0!==this.positions[e]&&(t=this.positions[e]),t}},Composer.Layer=class{constructor(e=null,t={}){this.scene=e,this.ingredient=t,this.layerEl=null;let i=void 0===t.zIndex?0:t.zIndex;this.scene.sceneEl.insertAdjacentHTML("beforeend",`\n            <div class = "layer layer-${t.getType()}"\n                 style = "z-index:${i};opacity:0"\n            >\n            </div>\n        `),this.layerEl=this.scene.sceneEl.lastElementChild,this.build()}isDevMode(){return this.scene.isDevMode()}build(){if("entire"===this.ingredient.getType()){let e=`\n                <div class = ''><img src='${this.ingredient.getImageUrls()[0]}'></div>\n            `;this.layerEl.insertAdjacentHTML("beforeend",e)}else if("particles"===this.ingredient.getType()){let e=this.ingredient.getImageUrls(),t=10;if(void 0!==this.ingredient.count)t=this.ingredient.count;else{let e=this.ingredient.getParticlesPositions("small");e&&(t=e.length)}let i="";for(let s=0;s<t;s++){i+=`\n                    <div class = 'particle'><img src='${e[Utils.random(0,e.length-1)]}'></div>\n                `}this.layerEl.insertAdjacentHTML("beforeend",i)}}animate(){if(this.layerEl.style.opacity=1,"entire"===this.ingredient.getType())this.layerEl.animate([{transform:"rotate(0deg)",left:"-100%",opacity:0},{transform:"rotate(360deg)",left:"0%",opacity:1}],{duration:1500,iterations:1,easing:"ease-out",fill:"forwards"});else if("particles"===this.ingredient.getType()){let e="small",t=this.layerEl.querySelectorAll(".particle"),i=this.ingredient.getParticlesPositions(e),s=!1;i&&this.scene.getLayerCount(this.ingredient.name)<=1&&(s=!0);const n="px";let r=-1;t.forEach((e=>{l(e);r++;let t="",a={x:0,y:0};Math.random()<=.5?a.x=-100:a.x=Utils.random(-300,this.scene.baseWidth()+100),a.y=Utils.random(-300,this.scene.baseHeight()+100);let o=Math.max(e.clientWidth,e.clientHeight);t+=`max: ${o},`;let c=null;if(s)c=new LightScene.Point(i[r][0],i[r][1]),c.substract(o/2);else{let i=o+140,s=this.scene.baseWidth()-i;t+=`diameter: ${s}, `;let n=new LightScene.Point(i/2,i/2),r=new LightScene.Point(n);r.substract(e.clientWidth/2,e.clientHeight/2),t+=`translateEndPos: ${r}, `,c=new LightScene.Point(Utils.randomInsideCircle(s)),c.add(r)}t+=`x:${c.x}, y:${c.y},`;let h=Utils.random(1,360),d=Utils.random(500,1e3);e.animate([{transform:"rotate(0deg)",left:a.x+n,top:a.y+n,opacity:.5},{transform:`rotate(${h}deg)`,left:c.x+n,top:c.y+n,opacity:.95}],{duration:d,iterations:1,easing:"ease-out",fill:"forwards"})}))}}remove(e){Utils.random(1,360);this.layerEl.animate([{opacity:0}],{duration:1e3,fill:"forwards"}).onfinish=()=>{this.layerEl.remove(),e()}}},Composer.Scene=class{constructor(e,t){this.composer=e,this.layers=[],this.sceneEl=this.composer.composerEl.querySelector(t),this.scale=null,this.sceneRotationAnim=null}isDevMode(){return this.composer.isDevMode()}build(){window.addEventListener("resize",(()=>{this.scaleScene()})),this.scaleScene(),this.sceneEl.addEventListener("mousemove",(e=>{this.updateDevInfo(e)})),setTimeout((()=>{this.sceneRotationAnim=this.sceneEl.animate([{},{transform:"rotate(360deg)"}],{duration:18e4,iterations:1/0,easing:"linear"}),this.isDevMode()&&this.sceneRotationAnim.pause()}),0)}updateDevInfo(e=null){let t="";if(t+=`Scale: ${this.scale.toFixed(2)}`,e){var i=e.target.getBoundingClientRect();let s=e.clientX-i.left,n=e.clientY-i.top;s=(s*(1/this.scale)).toFixed(0),n=(n*(1/this.scale)).toFixed(0),t+=` X: ${s}, Y: ${n}`}l(".dev-scene-info").text(t)}scaleScene(){const e=l(this.sceneEl).closest(".scene-wrapper")[0],t=l(this.sceneEl).closest(".scene-scale")[0];e.style.height=null;let i=0;i=Math.min(e.clientWidth/t.clientWidth,e.clientHeight/t.clientHeight),this.scale=i,t.style.transform=`scale(${i})`;const s=t.getBoundingClientRect();e.style.height=`${s.height}px`,e.style["padding-left"]=(e.clientWidth-s.width)/2+"px",this.updateDevInfo()}width(){return this.sceneEl.clientWidth}height(){return this.sceneEl.clientHeight}baseWidth(){return this.width()}baseHeight(){return this.height()}baseRect(){return new LightScene.Rect({x:0,y:0,width:this.baseWidth(),height:this.baseHeight()})}getLayers(){return this.layers}addLayer(e){let t=new Composer.Layer(this,e);this.layers.push(t),setTimeout((()=>{t.animate()}),100)}removeLayer(e){this.layers[e].remove((()=>{})),this.layers.splice(e,1)}getLayerIndex(e,t=!0){if(!t){let t=null;return this.layers.some(((i,s)=>{if(i.ingredient.name===e)return t=s,!0})),t}for(var i=this.layers.length-1;i>=0;i--)if(this.layers[i].ingredient.name===e)return i;return null}getLayer(e,t=!0){let i=this.getLayerIndex(e,t);return null===i?null:this.layers[i]}getLayerCount(e){let t=0;for(let i=0;i<this.layers.length;i++)this.layers[i].ingredient.name===e&&t++;return t}},Composer.Menu=class{constructor(e,t){this.composer=e,this.menuEl=this.composer.composerEl.querySelector(t),this.build()}build(){let e="",t=this.composer.getIngredientsBySections();for(var i in t){if("Ciasto"===i)continue;let s=t[i];e+=`\n                <div class = 'menu-section'>\n                    <span class = "menu-section-label">${i}</span>\n                    <div class = "menu-section-content">\n                        <ul>\n            `,s.forEach(((t,i)=>{e+=`\n                <li class = 'menu-ingredient' data-ingredient-index = '${i}' data-ingredient-name = '${t.name}'>\n                    \x3c!-- <img src = '${t.getThumbUrl()}'> --\x3e\n                    <span class = 'menu-ingredient-change menu-ingredient-minus'><span class="fas fa-minus"></span></span>\n                    <span class = 'menu-ingredient-name'>\n                        ${t.display.pl}\n                        <span class = 'menu-ingredient-count'></span>\n                    </span>\n                    <span class = 'menu-ingredient-change menu-ingredient-plus'><span class="fas fa-plus"></span></span>\n                    <br class = 'clear-fix'>\n                `})),e+="</ul></div></div>"}let s=e.replace(/>(\s)*/gi,">");this.menuEl.insertAdjacentHTML("beforeend",s),l(this.menuEl).on("click",(e=>{let t=l(e.target).closest(".menu"),i=l(e.target).closest(".menu-section-label");if(0==i.length)return;let s=i.closest(".menu-section"),n=(s[0],s.find(".menu-section-content"));if(t.find(".menu-section").forEach((e=>{let t=l(e).find(".menu-section-content")[0];l(e).removeClass("menu-section-active"),e!==s[0]&&t.style.maxHeight&&(t.style.maxHeight=null)})),n.length>0){let e=n[0];e.style.maxHeight?e.style.maxHeight=null:(s.addClass("menu-section-active"),e.style.maxHeight=e.scrollHeight+"px")}})),l(this.menuEl).find(".menu-ingredient").on("click",(e=>{this.onClick(l(e.target))}))}onClick(e){this.composer.onMenuClick(e)}updateCalculations(){let e=0;return e=12,l(this.menuEl).find(".menu-ingredient").each((t=>{let i=t.attr("data-ingredient-name"),s=this.composer.scene.getLayerCount(i),n=this.composer.getIngredientByName(i);s?(t.find(".menu-ingredient-count").text(` x${s}`),e+=n.price*s):t.find(".menu-ingredient-count").text("")})),e}},Composer.Composer=class{constructor(e,t,i=!0){this.app=e,this.ingredients=[],this.app.data.ingredients.forEach((t=>{let i=new Composer.Ingredient(e,t);this.ingredients.push(i)})),this.composerEl=this.app.appEl.querySelector(t),this.scene=new Composer.Scene(this,".scene"),this.menu=new Composer.Menu(this,".menu"),this.menuLastAction=null,this.dishPriceAnimCurDeg=0,i&&this.build()}isDevMode(){return this.app.isDevMode()}build(){this.ingredients.forEach((e=>{e.hasMode("autoadd")&&this.addLayer(e)})),this.scene.build()}onMenuClick(e){let t=e.closest(".menu-ingredient").attr("data-ingredient-name"),i=this.getIngredientByName(t);if(null!==i){let s=!1;if(e.closest(".menu-ingredient-change").is(".menu-ingredient-plus")||e.closest(".menu-ingredient-name").length>0)this.addLayer(i),s=!0,this.menuLastAction="ingredientPlus";else if(e.closest(".menu-ingredient-change").is(".menu-ingredient-minus")){let e=this.scene.getLayerIndex(t,!0);null!==e&&this.scene.removeLayer(e),s=!0,this.menuLastAction="ingredientMinus"}s&&this.updateCalculations()}}getIngredients(){return this.ingredients}getIngredientsBySections(){let e=this.getIngredients(),t={};return e.forEach((e=>{let i=void 0===e.section?"Dodatki":e.section.pl;void 0===t[i]&&(t[i]=[]),t[i].push(e)})),t}getIngredientByName(e){return this.getIngredients().find((t=>t.name===e))||null}addLayer(e){this.scene.addLayer(e)}prefetchIngredientsImages(e){let t=[];this.ingredients.forEach(((e,i)=>{let s=e.getImageUrls();t=[...t,...s]}));let i=0;t.forEach((s=>{let n=new Image;n.src=s,n.onload=()=>{i++,e(i,t.length,s)}}))}getPrice(){let e=this.scene.getLayers(),t=0;return e.forEach((e=>{t+=void 0===e.ingredient.price?0:e.ingredient.price})),t}updateCalculations(){let e=this.menu.updateCalculations();this.app.appEl.querySelector(".dish-price .dish-price-price").textContent=parseFloat(e).toFixed(2).toString().replaceAll(".",",");let t=this.dishPriceAnimCurDeg;"ingredientPlus"===this.menuLastAction?t+=5:"ingredientMinus"===this.menuLastAction&&(t-=5),this.app.appEl.querySelector(".dish-price .dish-price-img").animate([{transform:`rotate(${this.dishPriceAnimCurDeg}deg)`},{transform:`rotate(${t}deg)`}],{duration:300,iterations:1,easing:"ease-out",fill:"forwards"}),this.dishPriceAnimCurDeg=t}};class App{constructor(e){this.data=e.data,this.setupUrl(),this.setupStyle(),this.setupDevMode(),this.appEl=e.container instanceof Node?e.container:document.querySelector(e.container),this.composer=new Composer.Composer(this,".composer-container",!1),console.log("uparam:",this.getUrlParam("devMode"));let t=new Image;t.src="./assets/images/dish-price.png",this.composer.prefetchIngredientsImages(((e,i,s)=>{let n=Math.round(100/(i/(e||1)));if(l(".loader-progress").text(`Loading: ${n}%`),e===i){l(".loader")[0].animate([{opacity:0}],{duration:400,fill:"forwards"}).onfinish=()=>{l(".loader")[0].remove(),this.composer.composerEl.style.display="block",this.composer.build(),this.composer.updateCalculations();let e=()=>{setTimeout((()=>{l(".dish-price")[0].animate([{scale:0,opacity:1},{scale:1,opacity:1,transform:"rotate(360deg) translateX(0%)"}],{duration:500,fill:"forwards",easing:"ease-out"})}),1500)};t.complete&&0!==t.naturalHeight?e():t.onload=()=>{e()}}}})),l(".actions-ready").on("click",(()=>{alert("Zamówienie zostało zrealizowane")}))}setupUrl(){let e=Composer.currentScript.src;"/"===e[e.length-1]&&(e=e.slice(0,-1)),this.url=e.split("/").slice(0,-2).join("/")}setupDevMode(){this.devMode=!1,-1!==window.location.href.indexOf("://local.yummy")&&(this.devMode=!0);const e=this.getUrlParam("devMode");"true"===e||1==e?this.devMode=!0:"false"!==e&&0!=e||(this.devMode=!1),this.isDevMode()?(this.data.ingredients.push({name:"dev-point-square",display:{pl:"Kwadraty (10x10px)"},section:{pl:"Developer"},count:100,zIndex:50,price:1},{name:"dev-point-circle",display:{pl:"Koła (20x20px)"},section:{pl:"Developer"},count:100,zIndex:50,price:1}),l(".dev-smoke-active").on("change",(()=>{l(".dev-smoke-active")[0].checked?(l(".scene-wrapper .smoke").css("display","block"),l(".scene-wrapper .smoke video")[0].play()):(l(".scene-wrapper .smoke").css("display","none"),l(".scene-wrapper .smoke video")[0].pause())})),l(".dev-scene-rotation-active").on("change",(()=>{this.composer.scene.sceneRotationAnim?l(".dev-scene-rotation-active")[0].checked?this.composer.scene.sceneRotationAnim.play():this.composer.scene.sceneRotationAnim.pause():alert("Not started yet (3s)")}))):l(".developer").css("display","none")}setupStyle(){let e=this.getUrlParam("style");e&&l("head").insertAdjacentHTML("beforeend",`\n                <link rel="stylesheet" href="./assets/css/themes/${e}.css">\n\n        `)}getUrlParam(e,t=null){let i=null;const s=window.location!=window.parent.location?document.referrer:document.location.href;if(s){const t=new URL(s).searchParams.get(e);null!==t&&(i=t)}if(null===i){const t=new URL(document.location.href).searchParams.get(e);null!==t&&(i=t)}return null===i?t:i}isDevMode(){return!0===this.devMode}}